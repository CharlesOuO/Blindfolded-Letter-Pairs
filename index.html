<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Letter Pairs Practice (Responsive & Fixed)</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-body: #f8fafc;
            --text-main: #0f172a;
            --text-sub: #64748b;
            
            --status-green: #dcfce7; --status-green-border: #86efac;
            --status-yellow: #fef9c3; --status-yellow-border: #fde047;
            --status-red: #fee2e2;    --status-red-border: #fca5a5;
            
            --guide-highlight: #e0f2fe; 
            --guide-highlight-border: #7dd3fc;

            /* é›»è…¦ç‰ˆé è¨­å°ºå¯¸ */
            --cell-width: 44px;
            --cell-height: 38px;
            --header-height: 60px;
        }

        /* è‹±æ–‡æ¨¡å¼ï¼šå¯¬æ ¼å­ */
        body.mode-en { --cell-width: 68px; }
        /* ä¸­æ–‡æ¨¡å¼ï¼šç·Šæ¹Šæ ¼å­ */
        body.mode-zh { --cell-width: 44px; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- Navigation --- */
        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            width: 100%; height: var(--header-height);
            border-bottom: 1px solid #e2e8f0;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .nav-container {
            display: flex; gap: 4px; padding: 0 8px; 
            overflow-x: auto; /* æ‰‹æ©Ÿç‰ˆå°è¦½åˆ—å¯æ»‘å‹• */
            width: 100%; max-width: 900px; align-items: center; justify-content: center;
            scrollbar-width: none; /* Firefox éš±è—æ²è»¸ */
        }
        .nav-container::-webkit-scrollbar { display: none; /* Chrome éš±è—æ²è»¸ */ }
        
        .nav-btn {
            padding: 8px 16px; font-size: 0.95rem; border: none; background: transparent;
            color: var(--text-sub); cursor: pointer; font-weight: 600; border-radius: 6px;
            white-space: nowrap; transition: all 0.2s; flex-shrink: 0;
        }
        .nav-btn.active { color: var(--primary-color); background-color: #eff6ff; }
        .nav-btn:hover { background-color: #f1f5f9; color: var(--primary-color); }

        /* --- Layout Container --- */
        .container {
            /* é è¨­çª„ç‰ˆ (åˆ—è¡¨æ¨¡å¼) */
            max-width: 800px; 
            width: 95%; 
            margin: 20px auto 40px auto; 
            flex: 1; 
            transition: max-width 0.3s ease;
        }
        
        /* å¯¬ç‰ˆæ¨¡å¼ (Matrix) */
        .container.wide-mode {
            max-width: 100%; 
            width: 100%;
            padding: 0 16px;
        }

        /* --- Buttons --- */
        .action-btn {
            padding: 8px 14px; border-radius: 8px; border: 1px solid #cbd5e1;
            background: white; color: var(--text-main); font-size: 0.9rem; font-weight: 500;
            margin: 4px; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background-color: #eff6ff; }
        
        .btn-primary {
            background: var(--primary-color); color: white; border: none;
            padding: 12px 32px; font-size: 1rem; border-radius: 99px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); transition: all 0.2s;
            font-weight: 600;
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
        
        .btn-danger { color: #dc2626; border-color: #fca5a5; background: #fff; }
        .btn-danger:hover { background: #fef2f2; border-color: #dc2626; }
        
        .btn-sm { padding: 4px 10px; font-size: 0.85rem; border-radius: 6px; border: 1px solid #cbd5e1; background: #fff; margin-left: 4px; cursor: pointer; }
        .btn-sm:hover { border-color: var(--primary-color); color: var(--primary-color); }

        /* --- Matrix Table --- */
        .matrix-wrapper { 
            overflow: auto; 
            max-height: 75vh; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px; 
            background: white; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-right: 2px;
            
            /* --- é—œéµä¿®æ”¹ï¼šè§£æ±ºå³é‚Šç•™ç™½ä¸¦ç¶­æŒæ‰‹æ©Ÿç‰ˆæ­£å¸¸ --- */
            width: fit-content; 
            max-width: 100%; 
            margin: 0 auto;
        }

        .matrix-table { 
            border-collapse: separate; 
            border-spacing: 0; 
            width: max-content; 
            table-layout: fixed;
            margin-bottom: 2px;
        }
        
        .matrix-table th, .matrix-table td { 
            padding: 0;
            border-right: 1px solid #e2e8f0; 
            border-bottom: 1px solid #e2e8f0; 
            text-align: center; 
            width: var(--cell-width); 
            min-width: var(--cell-width); 
            max-width: var(--cell-width);
            height: var(--cell-height);
            overflow: hidden; white-space: nowrap;
            background: #fff; transition: background-color 0.1s;
        }

        /* Sticky Headers */
        .matrix-table thead th { position: sticky; top: 0; z-index: 10; background: #f1f5f9; color: #334155; font-weight: bold; border-bottom: 2px solid #cbd5e1; }
        .matrix-table tbody th { position: sticky; left: 0; z-index: 5; background: #f1f5f9; font-weight: bold; border-right: 2px solid #cbd5e1; }
        .matrix-table thead th:first-child { position: sticky; left: 0; top: 0; z-index: 20; background: #e2e8f0; border-right: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1; }

        /* Inputs */
        .matrix-input { width: 100%; height: 100%; border: none; outline: none; background: transparent; text-align: center; font-size: 13px; color: #0f172a; padding: 0 2px; display: block; border-radius: 0; }
        .matrix-input:focus { background: rgba(255,255,255,0.9); box-shadow: inset 0 0 0 2px var(--primary-color); font-weight: 600; }
        .header-input { width: 100%; background: transparent; border: none; text-align: center; font-weight: 700; color: #334155; cursor: pointer; outline: none; font-size: 0.85rem; padding: 0; border-radius: 0; }
        
        .diagonal-wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .diagonal-wrapper .matrix-input { height: 60%; font-size: 12px; }
        .btn-diagonal-check { height: 40%; width: 100%; font-size: 10px; padding: 0; margin: 0; border: none; border-top: 1px solid #e2e8f0; background: #f8fafc; color: var(--primary-color); cursor: pointer; line-height: 1; display: flex; align-items: center; justify-content: center; }
        .btn-diagonal-check:hover { background: var(--primary-color); color: white; }

        /* Highlight & Status */
        .status-green { background-color: var(--status-green) !important; }
        .status-yellow { background-color: var(--status-yellow) !important; }
        .status-red { background-color: var(--status-red) !important; }
        .highlight-guide { background-color: var(--guide-highlight) !important; }
        .highlight-guide.status-green { background-color: #bbf7d0 !important; }
        .highlight-guide.status-yellow { background-color: #fef08a !important; }
        .highlight-guide.status-red { background-color: #fecaca !important; }
        th.highlight-guide { background-color: #cbd5e1 !important; color: #1e3a8a; }

        /* --- Other Views --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; padding-bottom: 60px; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .control-panel { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        /* éŸ¿æ‡‰å¼ Grid */
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 10px; 
        }
        
        .pair-item { background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; transition: transform 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pair-item:hover { border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .pair-label { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 4px; font-weight: 500; }
        .pair-input { width: 100%; padding: 6px; text-align: center; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; -webkit-appearance: none; }
        .pair-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        .hidden { display: none !important; }

        .card-area { background: white; padding: 40px; border-radius: 16px; border: 1px solid #e2e8f0; text-align: center; margin: 20px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: relative; }
        .question { font-size: 5rem; margin-bottom: 15px; font-weight: 300; line-height: 1; }
        .answer-text { font-size: 2.5rem; color: #dc2626; display: none; font-weight: 600; margin-top: 10px; }
        .answer-text.show { display: block; animation: popIn 0.2s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .dropdown-wrapper { position: relative; display: inline-block; width: 100%; max-width: 300px; }
        .dropdown-content { display: none; position: absolute; background: white; border: 1px solid #e2e8f0; z-index: 999; padding: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; text-align: left; border-radius: 8px; left: 0; top: 110%; }
        .dropdown-content.show { display: block; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 220px; overflow-y: auto; }
        
        /* Footer */
        .main-footer { background: #0f172a; color: #94a3b8; padding: 30px 20px; text-align: center; margin-top: auto; font-size: 0.9rem; }
        .social-icons { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .icon-link svg { width: 24px; height: 24px; fill: #cbd5e1; transition: 0.2s; }
        .icon-link:hover svg { fill: white; transform: scale(1.1); }

        /* --- Mobile Responsive Rules (é—œéµçš„æ‰‹æ©Ÿç‰ˆèª¿æ•´) --- */
        @media (max-width: 768px) {
            :root {
                --header-height: 52px; /* ç¸®å°å°è¦½åˆ— */
            }
            .nav-container { justify-content: flex-start; padding: 0 12px; } /* å°è¦½åˆ—é å·¦å°é½Šæ–¹ä¾¿æ»‘å‹• */
            .nav-btn { padding: 6px 12px; font-size: 0.9rem; }
            
            .container { width: 100%; padding: 0 12px; margin: 15px auto; }
            .container.wide-mode { padding: 0 10px; }
            
            .control-panel { padding: 15px; margin-bottom: 15px; }
            
            .card-area { padding: 25px 15px; }
            .question { font-size: 3.5rem; } /* ç¸®å°å¤§æ¨™é¡Œ */
            .answer-text { font-size: 2rem; }
            
            /* æ‰‹æ©Ÿä¸Šåˆ—è¡¨è¼¸å…¥æ¡†æœ€å° 16px é˜²æ­¢ iOS ç¸®æ”¾ */
            .pair-input, .matrix-input, #test-input { font-size: 16px; }
            
            .grid-container {
                grid-template-columns: repeat(3, 1fr); /* å¼·åˆ¶æ‰‹æ©Ÿç‰ˆä¸€æ’ä¸‰å€‹ */
                gap: 8px;
            }
            .pair-item { padding: 8px 4px; }
            .pair-input { padding: 4px; font-size: 16px; border-radius: 4px; }
            
            /* å…¨è¡¨æ¨¡å¼åœ¨æ‰‹æ©Ÿä¸Šå¾®èª¿ */
            .matrix-wrapper { border-radius: 6px; }
            
            /* èª¿æ•´æŒ‰éˆ•å¤§å°æ–¹ä¾¿è§¸æ§ */
            .btn-primary { width: 100%; padding: 14px; }
            .action-btn { padding: 10px 16px; }
            
            .dropdown-wrapper { max-width: 100%; }
            .checkbox-grid { grid-template-columns: repeat(4, 1fr); }
            
            /* ä¿®æ­£æ‰“å­—æ¸¬é©—è¼¸å…¥æ¡† */
            #test-input { width: 100%; max-width: none; }
        }
    </style>
</head>
<body onload="init()">
    <div class="nav-bar">
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchTab('list')" data-i18n="nav_list">åˆ—è¡¨è¼¸å…¥</button>
            <button class="nav-btn" onclick="switchTab('memory')" data-i18n="nav_mem">è¨˜æ†¶ç¿»ç‰Œ</button>
            <button class="nav-btn" onclick="switchTab('test')" data-i18n="nav_test">æ‰“å­—æ¸¬é©—</button>
            <button class="nav-btn" onclick="switchTab('data')" data-i18n="nav_data">è³‡æ–™å‚™ä»½</button>
        </div>
    </div>

    <div id="main-container" class="container">
        
        <div id="view-list" class="view-section active">
            <div class="control-panel">
                <div style="margin-bottom: 16px;">
                    <button id="btn-mode-list" class="action-btn" onclick="toggleViewMode('list')" style="border-color:var(--primary-color); color:var(--primary-color);">ğŸ“‹ <span data-i18n="mode_card">åˆ—è¡¨æ¨¡å¼</span></button>
                    <button id="btn-mode-matrix" class="action-btn" onclick="toggleViewMode('matrix')">â–¦ <span data-i18n="mode_matrix">å…¨è¡¨æ¨¡å¼</span></button>
                </div>
                
                <div id="list-mode-controls">
                    <label data-i18n="lbl_start_char" style="font-weight:500;">é–‹é ­ï¼š</label>
                    <select id="char-select" onchange="renderList()" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; outline:none; font-size:16px;"></select>
                </div>
                
                <div id="matrix-settings" class="hidden" style="margin-top: 10px;">
                    <span style="font-size:0.85rem; color:#64748b;" data-i18n="hint_matrix_edit">æç¤ºï¼šé»æ“Šè¡¨é ­å¯ä¿®æ”¹ä»£ç¢¼</span>
                    <button class="btn-sm" onclick="resetDefaultChars()" data-i18n="btn_reset_chars">é‡ç½®ä»£ç¢¼</button>
                </div>
                
                <div style="margin-top: 16px; border-top: 1px solid #f1f5f9; padding-top: 16px;">
                    <button class="action-btn" onclick="resetAllColors()" style="font-size: 0.85rem; color: #64748b;" data-i18n="btn_reset_color">ğŸ”„ é‡ç½®æ‰€æœ‰é¡è‰²</button>
                </div>
            </div>

            <div id="grid-area" class="grid-container"></div>
            
            <div id="matrix-area" class="matrix-wrapper hidden">
                <table id="full-matrix" class="matrix-table"></table>
            </div>
        </div>

        <div id="view-memory" class="view-section">
            <div class="control-panel">
                <label data-i18n="lbl_range" style="font-weight:500;">ç¯„åœï¼š</label>
                <div class="dropdown-wrapper">
                    <button id="mem-dropdown-btn" onclick="toggleDropdown('mem')" class="action-btn" style="width:100%; justify-content:space-between; display:inline-flex;">é¸æ“‡ç¯„åœ â–¼</button>
                    <div class="dropdown-content" id="mem-dropdown-content">
                        <div style="margin-bottom:8px; display:flex; gap:5px; padding-bottom:8px; border-bottom:1px solid #eee;">
                            <button class="btn-sm" onclick="toggleAll('mem', true)" style="flex:1;">å…¨é¸</button>
                            <button class="btn-sm" onclick="toggleAll('mem', false)" style="flex:1;">å…¨æ¶ˆ</button>
                        </div>
                        <div id="mem-range-grid" class="checkbox-grid"></div>
                    </div>
                </div>
            </div>
            <div class="card-area" onclick="toggleMemoryAnswer()">
                <div class="question" id="mem-q">FO</div>
                <div class="answer-text" id="mem-a">...</div>
                <div style="margin-top:30px; color:#94a3b8; font-size:0.9rem;" id="mem-hint" data-i18n="hint_click_flip">é»æ“Šå¡ç‰‡ç¿»ç‰Œ</div>
            </div>
            <div style="text-align:center; margin-bottom:20px;">
                <button class="btn-primary" onclick="nextMemoryCard()" id="btn-next-mem" data-i18n="btn_next">ä¸‹ä¸€é¡Œ (Space)</button>
            </div>
        </div>

        <div id="view-test" class="view-section">
            <div class="control-panel">
                <label data-i18n="lbl_test_range" style="font-weight:500;">ç¯„åœï¼š</label>
                <div class="dropdown-wrapper">
                    <button id="test-dropdown-btn" onclick="toggleDropdown('test')" class="action-btn" style="width:100%; justify-content:space-between; display:inline-flex;">é¸æ“‡ç¯„åœ â–¼</button>
                    <div class="dropdown-content" id="test-dropdown-content">
                        <div style="margin-bottom:8px; display:flex; gap:5px; padding-bottom:8px; border-bottom:1px solid #eee;">
                            <button class="btn-sm" onclick="toggleAll('test', true)" style="flex:1;">å…¨é¸</button>
                            <button class="btn-sm" onclick="toggleAll('test', false)" style="flex:1;">å…¨æ¶ˆ</button>
                        </div>
                        <div id="test-range-grid" class="checkbox-grid"></div>
                    </div>
                </div>
            </div>
            <div class="card-area">
                <div id="timer" style="font-family:monospace; font-size:1.5rem; margin-bottom:15px; color:#64748b; background:#f1f5f9; display:inline-block; padding:5px 15px; border-radius:20px;">0.0s</div>
                <div class="question" id="test-q">?</div>
                <input type="text" id="test-input" style="padding:12px; text-align:center; margin-top:15px; border:2px solid #e2e8f0; border-radius:8px; outline:none;" autocomplete="off" placeholder="Type here">
                <div id="test-feedback" style="margin-top:20px; font-weight:bold; min-height:28px; font-size:1.1rem;"></div>
                <div id="test-correct-msg" style="margin-top:5px; min-height:28px;"></div>
            </div>
            <div style="text-align:center; margin-bottom:20px;">
                <button class="btn-primary" id="test-btn" onclick="startTestQuestion()" data-i18n="btn_start_test">é–‹å§‹æ¸¬é©— (Space)</button>
            </div>
        </div>

        <div id="view-data" class="view-section">
            <div class="control-panel">
                <h3 data-i18n="title_backup" style="margin-top:0;">è³‡æ–™å‚™ä»½</h3>
                <div style="padding:20px 0;">
                    <button class="action-btn" onclick="exportData()" data-i18n="btn_export" style="padding:10px 20px;">ğŸ“¥ ä¸‹è¼‰å‚™ä»½ (.json)</button>
                </div>
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:20px; background:#f9fafb; border-radius:8px;">
                    <label data-i18n="lbl_select_file" style="display:block; margin-bottom:10px; color:#64748b;">åŒ¯å…¥æª”æ¡ˆï¼š</label>
                    <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
                        <input type="file" id="file-input" accept=".json" style="border:1px solid #cbd5e1; padding:5px; border-radius:4px; background:white; width:100%; max-width:250px;">
                        <button class="action-btn" onclick="importData()" style="color:#166534; border-color:#86efac; background:#dcfce7;" data-i18n="btn_import">ç¢ºèªåŒ¯å…¥</button>
                    </div>
                </div>
                <div style="margin-top:40px;">
                    <button class="btn-danger action-btn" onclick="clearAllData()" data-i18n="btn_clear_all">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <div class="social-icons">
            <a href="https://www.worldcubeassociation.org/persons/2020LINC05" target="_blank" class="icon-link"><svg viewBox="0 0 24 24"><path d="M12.0003 2.50815L2.8374 7.11885L12.0003 12.3331L21.1631 7.11885L12.0003 2.50815ZM1.64209 8.65082V16.892L10.893 22.091V13.8499L1.64209 8.65082ZM13.1075 13.8499V22.091L22.3584 16.892V8.65082L13.1075 13.8499Z"/></svg></a>
            <a href="https://www.instagram.com/chihjialin/" target="_blank" class="icon-link"><svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg></a>
            <a href="https://github.com/CharlesOuO" target="_blank" class="icon-link"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" /></svg></a>
            <a href="mailto:your-email@example.com" class="icon-link"><svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z" /></svg></a>
        </div>
        <div style="margin-bottom:8px;">&copy; 2026 Charles Lin. WCA ID: 2020LINC05</div>
        <button onclick="toggleLanguage()" style="background:transparent; border:1px solid #64748b; color:#94a3b8; border-radius:20px; padding:4px 12px; cursor:pointer; font-size:0.8rem; transition:0.2s;">English / ä¸­æ–‡</button>
    </footer>

    <script>
        const CHARS_ZH = ['ã„…','ã„†','ã„‡','ã„ˆ','ã„‰','ã„Š','ã„‹','ã„Œ','ã„','ã„','ã„','ã„','ã„‘','ã„’','ã„“','ã„”','ã„•','ã„–','ã„—','ã„˜','ã„™','ã„§','ã„¨','ã„©'];
        const CHARS_EN = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X'];
        let chars = [...CHARS_ZH];
        const STORAGE_KEY = 'bld_custom_dict_v3'; const STATUS_KEY = 'bld_status_v1'; const LANG_KEY = 'bld_lang_v1'; const CHARS_KEY = 'bld_chars_v1';
        let currentPair = null; let isMemAnswerShown = false; let testStartTime = 0; let isWaitingTestNext = true; let timerInterval = null; let lastMemPair = null; let lastTestPair = null;
        let currentLang = localStorage.getItem(LANG_KEY) || 'zh-TW';
        let isMatrixMode = false;

        const translations = {
            'zh-TW': {
                nav_list: "åˆ—è¡¨è¼¸å…¥", nav_mem: "è¨˜æ†¶ç¿»ç‰Œ", nav_test: "æ‰“å­—æ¸¬é©—", nav_data: "è³‡æ–™å‚™ä»½",
                lbl_start_char: "é–‹é ­ä»£ç¢¼ï¼š", legend_title: "é¡è‰²ä¾†è‡ªæ¸¬é©—ï¼š", btn_reset_color: "ğŸ”„ é‡ç½®æ‰€æœ‰é¡è‰²",
                lbl_range: "é¸æ“‡ç¯„åœï¼š", lbl_test_range: "æ¸¬é©—ç¯„åœï¼š", btn_next: "ä¸‹ä¸€é¡Œ (Space)", btn_start_test: "é–‹å§‹æ¸¬é©— (Space)", 
                btn_submit: "æäº¤ (Enter)", ph_input: "è¼¸å…¥å¾ŒæŒ‰ Enter", title_backup: "è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ", btn_export: "ä¸‹è¼‰å‚™ä»½", 
                btn_import: "ç¢ºèªåŒ¯å…¥", btn_clear_all: "æ¸…ç©ºæ‰€æœ‰è³‡æ–™", hint_matrix_edit: "æç¤ºï¼šé»æ“Šè¡¨é ­å¯ä¿®æ”¹ä»£ç¢¼",
                btn_reset_chars: "å›å¾©é è¨­", mode_card: "åˆ—è¡¨æ¨¡å¼", mode_matrix: "å…¨è¡¨æ¨¡å¼", btn_same: "åŒ",
                alert_chars_empty: "è¼¸å…¥ä¸èƒ½ç‚ºç©ºï¼", alert_reset: "ç¢ºå®šé‡ç½®ï¼Ÿ", alert_reset_done: "å·²é‡ç½®", 
                opt_start: " é–‹é ­", sel_full: "å…¨ç¯„åœ", sel_none: "æœªé¸æ“‡", sel_count: "å·²é¸ {n} å€‹", sel_prefix: "å·²é¸ï¼š",
                hint_click_flip: "é»æ“Šç¿»ç‰Œ", fb_empty: "âŒ ç©ºç™½è·³é", fb_wrong: "âŒ éŒ¯èª¤", fb_slow: "â­• å¤ªæ…¢", fb_good: "âœ¨ ç†Ÿç·´",
                ans_prefix: "ç­”æ¡ˆï¼š", alert_no_data: "è«‹å…ˆè¼¸å…¥è³‡æ–™ï¼", alert_sel_range: "è«‹é¸æ“‡ç¯„åœ", alert_import_success: "åŒ¯å…¥æˆåŠŸ", alert_import_error: "æ ¼å¼éŒ¯èª¤"
            },
            'en': {
                nav_list: "List Input", nav_mem: "Flashcards", nav_test: "Typing Test", nav_data: "Backup",
                lbl_start_char: "Start Code:", legend_title: "Colors from Test:", btn_reset_color: "ğŸ”„ Reset Colors",
                lbl_range: "Select Range:", lbl_test_range: "Test Range:", btn_next: "Next (Space)", btn_start_test: "Start Test (Space)",
                btn_submit: "Submit (Enter)", ph_input: "Type & Enter", title_backup: "Backup & Restore", btn_export: "Download Backup",
                btn_import: "Import", btn_clear_all: "Clear All Data", hint_matrix_edit: "Click header to edit code",
                btn_reset_chars: "Reset Default", mode_card: "List Mode", mode_matrix: "Matrix Mode", btn_same: "Same",
                alert_chars_empty: "Cannot be empty!", alert_reset: "Are you sure?", alert_reset_done: "Reset done.",
                opt_start: " Start", sel_full: "All", sel_none: "None", sel_count: "{n} selected", sel_prefix: "Sel: ",
                hint_click_flip: "Click to flip", fb_empty: "âŒ Skipped", fb_wrong: "âŒ Wrong", fb_slow: "â­• Slow", fb_good: "âœ¨ Good",
                ans_prefix: "Ans: ", alert_no_data: "No data!", alert_sel_range: "Select range", alert_import_success: "Success", alert_import_error: "Error"
            }
        };

        function t(key, params = {}) { let str = translations[currentLang][key] || key; Object.keys(params).forEach(k => { str = str.replace(`{${k}}`, params[k]); }); return str; }
        function getDict() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
        function saveDict(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
        function getStatus() { return JSON.parse(localStorage.getItem(STATUS_KEY)) || {}; }
        function saveStatus(pair, status) { const s = getStatus(); s[pair] = status; localStorage.setItem(STATUS_KEY, JSON.stringify(s)); }

        function init() {
            const savedChars = localStorage.getItem(CHARS_KEY);
            if (savedChars) chars = JSON.parse(savedChars);
            initUI(); applyLanguage();
            updateLayoutMode();
            
            document.addEventListener('click', function(e) { if (!e.target.closest('.dropdown-wrapper')) { closeAllDropdowns(); } });
            document.getElementById('test-input').addEventListener('keydown', function(e) { if(e.key === 'Enter') { e.stopPropagation(); checkTestAnswer(); } });
            document.addEventListener('keydown', function(e) {
                const activeTab = document.querySelector('.view-section.active').id;
                if (e.code === 'Space' || e.key === 'Enter') {
                    if(document.activeElement.tagName === 'INPUT' && !isWaitingTestNext && activeTab === 'view-test') return;
                    if(document.activeElement.tagName === 'INPUT' && document.activeElement.id !== 'test-input') return; 
                    e.preventDefault(); triggerAction(activeTab);
                }
            });
            renderList();
        }

        function updateLayoutMode() {
            if(chars.includes('A')) {
                document.body.classList.remove('mode-zh');
                document.body.classList.add('mode-en');
            } else {
                document.body.classList.remove('mode-en');
                document.body.classList.add('mode-zh');
            }
        }

        function initUI() {
            const listSel = document.getElementById('char-select'); listSel.innerHTML = '';
            chars.forEach(c => { let opt1 = document.createElement('option'); opt1.value = c; opt1.innerText = `${c}`; listSel.appendChild(opt1); });
            renderCheckboxes('mem-range-grid', 'mem'); renderCheckboxes('test-range-grid', 'test');
            updateDropdownLabel('mem'); updateDropdownLabel('test');
        }

        function toggleViewMode(mode) {
            isMatrixMode = (mode === 'matrix');
            const listBtn = document.getElementById('btn-mode-list');
            const matrixBtn = document.getElementById('btn-mode-matrix');
            const listControls = document.getElementById('list-mode-controls');
            const matrixSettings = document.getElementById('matrix-settings'); 
            const gridArea = document.getElementById('grid-area');
            const matrixArea = document.getElementById('matrix-area');
            const container = document.getElementById('main-container');

            if(isMatrixMode) {
                // å…¨è¡¨æ¨¡å¼ï¼šè®Šå¯¬
                container.classList.add('wide-mode');
                
                listBtn.style.borderColor = "#cbd5e1"; listBtn.style.color = "#64748b";
                matrixBtn.style.borderColor = "var(--primary-color)"; matrixBtn.style.color = "var(--primary-color)";
                listControls.classList.add('hidden'); matrixSettings.classList.remove('hidden'); 
                gridArea.classList.add('hidden'); matrixArea.classList.remove('hidden');
                renderMatrix();
            } else {
                // åˆ—è¡¨æ¨¡å¼ï¼šè®Šçª„
                container.classList.remove('wide-mode');
                
                matrixBtn.style.borderColor = "#cbd5e1"; matrixBtn.style.color = "#64748b";
                listBtn.style.borderColor = "var(--primary-color)"; listBtn.style.color = "var(--primary-color)";
                listControls.classList.remove('hidden'); matrixSettings.classList.add('hidden'); 
                gridArea.classList.remove('hidden'); matrixArea.classList.add('hidden');
                renderList();
            }
        }

        function renderList() {
            const startChar = document.getElementById('char-select').value;
            const container = document.getElementById('grid-area');
            const dict = getDict(); const statusMap = getStatus();
            container.innerHTML = ''; 
            chars.forEach((endChar) => {
                if (startChar === endChar) return; 
                const pair = startChar + endChar;
                const div = document.createElement('div'); div.className = 'pair-item';
                div.innerHTML = `<div class="pair-label">${pair}</div>`;
                const input = document.createElement('input'); input.className = 'pair-input';
                const st = statusMap[pair];
                if(st === 'green') input.classList.add('status-green');
                else if(st === 'yellow') input.classList.add('status-yellow');
                else if(st === 'red') input.classList.add('status-red');
                input.value = dict[pair] || "";
                input.oninput = function() { const d = getDict(); d[pair] = this.value.trim(); saveDict(d); };
                div.appendChild(input); container.appendChild(div);
            });
        }

        function renderMatrix() {
            const table = document.getElementById('full-matrix');
            const dict = getDict();
            const statusMap = getStatus();
            
            let html = '<thead><tr><th></th>';
            chars.forEach((c, index) => {
                html += `<th><input value="${c}" onchange="updateGlobalChar(${index}, this.value)" class="header-input char-idx-${index}"></th>`;
            });
            html += '</tr></thead><tbody>';

            chars.forEach((rowChar, rowIndex) => {
                html += `<tr><th><input value="${rowChar}" onchange="updateGlobalChar(${rowIndex}, this.value)" class="header-input char-idx-${rowIndex}"></th>`;
                chars.forEach((colChar, colIndex) => {
                    const pair = rowChar + colChar;
                    const st = statusMap[pair];
                    let cellClass = '';
                    if(st === 'green') cellClass = 'status-green';
                    else if(st === 'yellow') cellClass = 'status-yellow';
                    else if(st === 'red') cellClass = 'status-red';
                    
                    if (rowChar === colChar) {
                        html += `<td class="cell-diagonal ${cellClass}">
                            <div class="diagonal-wrapper">
                                <input class="matrix-input" value="${dict[pair]||''}" oninput="updateMatrixInput('${pair}', this.value)" onfocus="handleFocus(this)" onblur="handleBlur()">
                                <button class="btn-diagonal-check" onclick="fillSame('${pair}', '${rowChar}', this)">${t('btn_same')}</button>
                            </div>
                        </td>`;
                    } else {
                        html += `<td class="${cellClass}"><input class="matrix-input" value="${dict[pair]||''}" oninput="updateMatrixInput('${pair}', this.value)" onfocus="handleFocus(this)" onblur="handleBlur()"></td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        window.handleFocus = function(el) {
            const td = el.closest('td'); if(!td) return;
            const tr = td.parentElement; const table = document.getElementById('full-matrix');
            if(!tr || !table) return;
            const colIndex = td.cellIndex; const rowIndex = tr.rowIndex;
            for(let r = 0; r <= rowIndex; r++) { 
                if(table.rows[r] && table.rows[r].cells[colIndex]) table.rows[r].cells[colIndex].classList.add('highlight-guide'); 
            }
            for(let c = 0; c <= colIndex; c++) { 
                if(tr.cells[c]) tr.cells[c].classList.add('highlight-guide'); 
            }
        };
        window.handleBlur = function() { document.querySelectorAll('.highlight-guide').forEach(el => el.classList.remove('highlight-guide')); };

        window.updateGlobalChar = function(index, newValue) {
            const val = newValue.trim(); if (!val) { alert(t('alert_chars_empty')); return; }
            chars[index] = val; localStorage.setItem(CHARS_KEY, JSON.stringify(chars));
            document.querySelectorAll(`.char-idx-${index}`).forEach(inp => inp.value = val);
            initUI(); 
            updateLayoutMode();
        };
        window.updateMatrixInput = function(pair, val) { const d = getDict(); d[pair] = val.trim(); saveDict(d); };
        window.fillSame = function(pair, char, btn) { const d = getDict(); d[pair] = char; saveDict(d); btn.previousElementSibling.value = char; };

        function resetDefaultChars() {
            if(confirm(t('alert_reset'))) {
                chars = (currentLang === 'en') ? [...CHARS_EN] : [...CHARS_ZH];
                localStorage.removeItem(CHARS_KEY); initUI(); applyLanguage(); updateLayoutMode(); renderMatrix(); alert(t('alert_reset_done'));
            }
        }
        function toggleLanguage() {
            currentLang = currentLang === 'zh-TW' ? 'en' : 'zh-TW';
            localStorage.setItem(LANG_KEY, currentLang); applyLanguage();
            if (currentLang === 'en' && JSON.stringify(chars) === JSON.stringify(CHARS_ZH)) {
                if(confirm("Switch to English A-X?")) { chars = [...CHARS_EN]; localStorage.setItem(CHARS_KEY, JSON.stringify(chars)); initUI(); }
            } else if (currentLang === 'zh-TW' && JSON.stringify(chars) === JSON.stringify(CHARS_EN)) {
                if(confirm("åˆ‡æ›å›æ³¨éŸ³ï¼Ÿ")) { chars = [...CHARS_ZH]; localStorage.setItem(CHARS_KEY, JSON.stringify(chars)); initUI(); }
            }
            updateLayoutMode();
            if(isMatrixMode) renderMatrix();
        }
        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(translations[currentLang][key]) el.innerText = translations[currentLang][key]; });
            const listSel = document.getElementById('char-select'); const currentVal = listSel.value; listSel.innerHTML = ''; 
            chars.forEach(c => { let opt = document.createElement('option'); opt.value = c; opt.innerText = `${c}${t('opt_start')}`; listSel.appendChild(opt); });
            if(currentVal && chars.includes(currentVal)) listSel.value = currentVal; 
            if(isWaitingTestNext) document.getElementById('test-btn').innerText = t('btn_start_test'); else document.getElementById('test-btn').innerText = t('btn_submit');
            if(isMemAnswerShown) document.getElementById('mem-hint').innerText = t('btn_next'); else document.getElementById('mem-hint').innerText = t('hint_click_flip');
            updateDropdownLabel('mem'); updateDropdownLabel('test');
        }
        
        function toggleDropdown(prefix) { const content = document.getElementById(`${prefix}-dropdown-content`); const isShown = content.classList.contains('show'); closeAllDropdowns(); if (!isShown) content.classList.add('show'); }
        function closeAllDropdowns() { document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show')); }
        function updateDropdownLabel(prefix) { const selected = getSelectedRanges(prefix); const btn = document.getElementById(`${prefix}-dropdown-btn`); if (selected.length === chars.length) btn.innerText = t('sel_full'); else if (selected.length === 0) btn.innerText = t('sel_none'); else btn.innerText = selected.length <= 5 ? `${t('sel_prefix')}${selected.join(', ')}` : t('sel_count', {n: selected.length}); }
        function renderCheckboxes(containerId, prefix) { const container = document.getElementById(containerId); container.innerHTML = ''; chars.forEach((c) => { const label = document.createElement('label'); label.style = 'display:flex;align-items:center;'; const input = document.createElement('input'); input.type = 'checkbox'; input.value = c; input.name = prefix + '_range'; input.checked = true; input.onchange = () => updateDropdownLabel(prefix); label.appendChild(input); label.appendChild(document.createTextNode(c)); container.appendChild(label); }); }
        function toggleAll(prefix, state) { document.querySelectorAll(`input[name="${prefix}_range"]`).forEach(input => input.checked = state); updateDropdownLabel(prefix); }
        function getSelectedRanges(prefix) { return Array.from(document.querySelectorAll(`input[name="${prefix}_range"]:checked`)).map(i => i.value); }
        function triggerAction(tabId) { if(tabId === 'view-memory') { if(isMemAnswerShown) nextMemoryCard(); else toggleMemoryAnswer(); } else if(tabId === 'view-test') { if(isWaitingTestNext) startTestQuestion(); } }
        
        function switchTab(tab) { 
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active')); 
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active')); 
            document.getElementById(`view-${tab}`).classList.add('active'); 
            const btnIndex = {'list':0, 'memory':1, 'test':2, 'data':3}; 
            document.querySelectorAll('.nav-btn')[btnIndex[tab]].classList.add('active'); 
            
            // é—œéµä¿®æ­£ï¼šåˆ‡æ› Tab æ™‚ï¼Œç¢ºä¿å®¹å™¨å¯¬åº¦æ¢å¾©æ­£å¸¸
            const container = document.getElementById('main-container');
            if (tab === 'list' && isMatrixMode) {
                container.classList.add('wide-mode'); // å¦‚æœåœ¨åˆ—è¡¨é ä¸”æ˜¯å…¨è¡¨æ¨¡å¼ -> å¯¬
            } else {
                container.classList.remove('wide-mode'); // å…¶ä»–é é¢ -> çª„
            }

            if(timerInterval) clearInterval(timerInterval); 
            if(tab === 'list') { 
                if(isMatrixMode) renderMatrix();
                else renderList(); 
            } 
            if(tab === 'memory') nextMemoryCard(); 
            if(tab === 'test') { 
                document.getElementById('test-feedback').innerText = ''; 
                document.getElementById('test-correct-msg').innerText = ''; 
                isWaitingTestNext = true; applyLanguage(); 
            }
        }

        function resetAllColors() { 
            if(confirm(t('alert_reset'))) { 
                localStorage.setItem(STATUS_KEY, JSON.stringify({})); 
                if(isMatrixMode) renderMatrix(); 
                else renderList(); 
                alert(t('alert_reset_done')); 
            } 
        }
        function nextMemoryCard() {
            const selectedChars = getSelectedRanges('mem'); 
            if(selectedChars.length === 0) { 
                alert(t('alert_sel_range')); 
                return; 
            } 
            let potentialPair; 
            let attempts = 0; 
            do { 
                const randomStartChar = selectedChars[Math.floor(Math.random() * selectedChars.length)]; 
                let randomEndChar = chars[Math.floor(Math.random()*chars.length)]; 
                while(randomStartChar === randomEndChar) { 
                    randomEndChar = chars[Math.floor(Math.random()*chars.length)]; 
                } potentialPair = randomStartChar + randomEndChar; attempts++; 
            } while (potentialPair === lastMemPair && attempts < 10); 
            lastMemPair = potentialPair; 
            currentPair = potentialPair; 
            document.getElementById('mem-q').innerText = currentPair; 
            document.getElementById('mem-a').classList.remove('show'); 
            isMemAnswerShown = false; applyLanguage(); 
        }
        function toggleMemoryAnswer() { 
            if(isMemAnswerShown) return; 
            const word = getDict()[currentPair] || "N/A"; document.getElementById('mem-a').innerText = word; 
            document.getElementById('mem-a').classList.add('show'); 
            isMemAnswerShown = true; applyLanguage(); 
        }
        function startTestQuestion() { 
            const dict = getDict(); 
            const statusMap = getStatus(); 
            const valid = Object.keys(dict).filter(k => dict[k]); // æœ‰è³‡æ–™çš„é¡Œç›®
            
            if(valid.length === 0) return alert(t('alert_no_data')); 
            
            const selectedChars = getSelectedRanges('test'); 
            if(selectedChars.length === 0) return alert(t('alert_sel_range')); 
            
            // 1. ç¯©é¸å‡ºç¬¦åˆç¯„åœçš„é¡Œç›®
            let candidates = valid.filter(p => selectedChars.includes(p[0])); 
            if(candidates.length === 0) return alert(t('alert_no_data')); 

            // é¿å…é€£çºŒå‡ºç¾åŒä¸€é¡Œ (é™¤éåªæœ‰ä¸€é¡Œ)
            let pool = candidates; 
            if (candidates.length > 1 && lastTestPair) { 
                pool = candidates.filter(p => p !== lastTestPair); 
            } 

            // 2. åˆ†é¡
            let untested = []; // æ²’æ¸¬é
            let learning = []; // ä¸ç†Ÿ (ç´…/é»ƒ)
            let mastered = []; // ç†Ÿæ‚‰ (ç¶ )

            pool.forEach(p => { 
                const s = statusMap[p]; 
                if (!s) untested.push(p);          // ç„¡ç‹€æ…‹
                else if (s === 'green') mastered.push(p); // ç¶ è‰²
                else learning.push(p);             // ç´…è‰²æˆ–é»ƒè‰²
            }); 

            // 3. åŠ æ¬Šéš¨æ©Ÿé¸æ“‡ (æ¬Šé‡å¯åœ¨æ­¤èª¿æ•´)
            let targetGroup = [];
            const rand = Math.random();

            // é‚è¼¯ï¼š
            // å¦‚æœé‚„æœ‰ã€Œæœªæ¸¬é©—ã€ï¼Œ70% æ©Ÿç‡é¸æœªæ¸¬é©—ï¼Œ20% é¸ä¸ç†Ÿï¼Œ10% é¸ç†Ÿæ‚‰ã€‚
            // å¦‚æœã€Œæœªæ¸¬é©—ã€æ²’äº†ï¼Œå‰‡ 80% é¸ä¸ç†Ÿï¼Œ20% é¸ç†Ÿæ‚‰ã€‚
            // å¦‚æœåªå‰©å…¶ä¸­ä¸€é¡ï¼Œå°±ç›´æ¥é¸é‚£ä¸€é¡ã€‚

            if (untested.length > 0) {
                if (rand < 0.7) targetGroup = untested;       // 70% æ–°é¡Œç›®
                else if (rand < 0.9) targetGroup = (learning.length > 0) ? learning : untested; // 20% è¤‡ç¿’éŒ¯çš„
                else targetGroup = (mastered.length > 0) ? mastered : ((learning.length > 0) ? learning : untested); // 10% è¤‡ç¿’ç†Ÿçš„
            } else if (learning.length > 0) {
                if (rand < 0.8) targetGroup = learning;       // 80% è¤‡ç¿’éŒ¯çš„
                else targetGroup = (mastered.length > 0) ? mastered : learning; // 20% è¤‡ç¿’ç†Ÿçš„
            } else {
                targetGroup = mastered; // åªå‰©ç†Ÿçš„ï¼Œå°±ç·´ç†Ÿçš„
            }

            // 4. å‡ºé¡Œ
            currentPair = targetGroup[Math.floor(Math.random() * targetGroup.length)]; 
            lastTestPair = currentPair; 
            
            document.getElementById('test-q').innerText = currentPair; 
            const inp = document.getElementById('test-input'); 
            inp.value = ''; 
            inp.disabled = false; 
            inp.focus(); 
            
            document.getElementById('test-feedback').innerText = ''; 
            document.getElementById('test-correct-msg').innerText = ''; 
            isWaitingTestNext = false; 
            applyLanguage(); 
            
            if(timerInterval) clearInterval(timerInterval); 
            testStartTime = Date.now(); 
            document.getElementById('timer').innerText = "0.0s"; 
            timerInterval = setInterval(() => { 
                document.getElementById('timer').innerText = ((Date.now() - testStartTime) / 1000).toFixed(1) + "s"; 
            }, 100); 
        }
        function checkTestAnswer() { 
            if(isWaitingTestNext) return; 
            clearInterval(timerInterval); 
            const duration = (Date.now() - testStartTime) / 1000; 
            const val = document.getElementById('test-input').value.trim(); 
            const ans = getDict()[currentPair]; 
            let st = '', msg = ''; 
            if(val === '') { 
                st = 'red'; msg = t('fb_empty'); 
            } else if(val !== ans) { 
                st = 'red'; msg = t('fb_wrong'); 
            } else if(duration > 12) { 
                st = 'red'; msg = t('fb_slow'); 
            } else if(duration > 8) { 
                st = 'yellow'; msg = "OK"; 
            } else { st = 'green'; msg = t('fb_good'); 

            } 
            saveStatus(currentPair, st); 
            document.getElementById('test-feedback').innerText = msg + ` (${duration.toFixed(1)}s)`; 
            document.getElementById('test-correct-msg').innerText = t('ans_prefix') + ans; 
            document.getElementById('test-input').disabled = true; isWaitingTestNext = true; applyLanguage(); 
        }
        function exportData() { 
            const blob = new Blob([JSON.stringify({ 
                dict: getDict(), status: getStatus(), chars: chars })], {type: "application/json"}); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; 
                document.body.appendChild(a); 
                a.click(); document.body.removeChild(a); 
            }
        function importData() { 
            const fileInput = document.getElementById('file-input'); 
            const f = fileInput.files[0]; 
            if(!f) return; const r = new FileReader(); r.onload = (e) => { 
                try { const d = JSON.parse(e.target.result); 
                    if(d.dict) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d.dict)); 
                        localStorage.setItem(STATUS_KEY, JSON.stringify(d.status || {})); 
                        if(d.chars) { 
                            chars = d.chars; localStorage.setItem(CHARS_KEY, JSON.stringify(chars)); 
                        } 
                    } 
                    alert(t('alert_import_success')); 
                    initUI(); updateLayoutMode(); 
                    if(isMatrixMode) renderMatrix(); 
                    else renderList(); 
                } catch(err) { 
                    alert(t('alert_import_error')); 
                } 
            }; 
            r.readAsText(f); 
        }
        function clearAllData() { 
            if(confirm(t('alert_reset'))) { 
                localStorage.clear(); location.reload(); 
            } 
        }
    </script>
</body>
</html>